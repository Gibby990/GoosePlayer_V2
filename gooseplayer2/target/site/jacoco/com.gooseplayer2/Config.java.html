<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Config.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gooseplayer2</a> &gt; <a href="index.source.html" class="el_package">com.gooseplayer2</a> &gt; <span class="el_source">Config.java</span></div><h1>Config.java</h1><pre class="source lang-java linenums">package com.gooseplayer2;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.io.FileOutputStream;
import java.awt.*;
import java.util.Properties;
import java.util.Objects;
import com.formdev.flatlaf.intellijthemes.*;

import javax.swing.*;

import com.gooseplayer2.Packages.Slugcat;

public class Config extends JDialog {
<span class="nc" id="L20">    public static final String LIBRARY_PATH = initLibraryPath();</span>
<span class="nc" id="L21">    public static final String SETTINGS_FILE_PATH = initSettingsPath();</span>
<span class="nc" id="L22">    public static final String RESOURCES_FILE_PATH = System.getProperty(&quot;user.dir&quot;)+ File.separator + &quot;gooseplayer2&quot; + File.separator + &quot;src&quot; + File.separator + &quot;main&quot; + File.separator + &quot;resources&quot;;</span>

    private GridBagConstraints gbc;
    private GridBagLayout layout;
    private Properties p;
    private FileReader reader;
    private Slugcat Artificer; 

    private String currentTheme, currentStyle, currentMonoChannelName, currentMultiChannel1Name, currentMultiChannel2Name, currentMultiChannel3Name;

    private JButton saveButton;
    @SuppressWarnings(&quot;rawtypes&quot;)
    private JComboBox ThemeBox, StyleBox;
    private JSeparator Seperator;
    private JTextField MonoChannelField, MultiChannel1Field, MultiChannel2Field, MultiChannel3Field;
    private JLabel ThemeLabel, StyleLabel, RestartWarning, MonoChannelLabel, MultiChannel1Label, MultiChannel2Label, MultiChannel3Label;
    
    public Config(JFrame parent) throws IOException {
<span class="nc" id="L40">        super(parent, &quot;Settings&quot;, true);</span>
<span class="nc" id="L41">        setSize(300, 300);</span>
<span class="nc" id="L42">        setLocationRelativeTo(parent);</span>

<span class="nc" id="L44">        layout = new GridBagLayout();</span>
<span class="nc" id="L45">        gbc = new GridBagConstraints();</span>

<span class="nc" id="L47">        Seperator = new JSeparator();</span>
<span class="nc" id="L48">        Seperator.setOrientation(SwingConstants.HORIZONTAL); </span>

<span class="nc" id="L50">        Artificer = new Slugcat();</span>

<span class="nc" id="L52">        reader = new FileReader(SETTINGS_FILE_PATH);</span>
<span class="nc" id="L53">        p = new Properties();</span>
<span class="nc" id="L54">        p.load(reader);</span>

<span class="nc" id="L56">        currentTheme = p.getProperty(&quot;theme&quot;);</span>
<span class="nc" id="L57">        currentStyle = p.getProperty(&quot;style&quot;);</span>
<span class="nc" id="L58">        currentMonoChannelName = p.getProperty(&quot;monochannelname&quot;);</span>
<span class="nc" id="L59">        currentMultiChannel1Name = p.getProperty(&quot;multichannel1name&quot;);</span>
<span class="nc" id="L60">        currentMultiChannel2Name = p.getProperty(&quot;multichannel2name&quot;);</span>
<span class="nc" id="L61">        currentMultiChannel3Name = p.getProperty(&quot;multichannel3name&quot;);</span>

        //Theme List
<span class="nc" id="L64">        String[] themeList = {&quot;Light Flat&quot;, &quot;Solarized Light&quot;, &quot;Arc&quot;, &quot;Dark Flat&quot;, &quot;Arc Dark&quot;, &quot;Arc Dark Orange&quot;, &quot;Hiberbee Dark&quot;, &quot;Dark Purple&quot;, &quot;Nord&quot;};</span>
<span class="nc" id="L65">        String[] styleList = {&quot;Monochannel&quot;, &quot;Multichannel&quot;};</span>

<span class="nc" id="L67">        ThemeBox = new JComboBox&lt;&gt;(themeList);</span>
<span class="nc" id="L68">        ThemeBox.setSelectedItem(currentTheme);</span>
<span class="nc" id="L69">        ThemeBox.addActionListener(new ActionListener() {</span>
            @SuppressWarnings(&quot;rawtypes&quot;)
            @Override
            public void actionPerformed(ActionEvent e) {
<span class="nc" id="L73">                try (FileWriter writer = new FileWriter(SETTINGS_FILE_PATH)) {</span>
<span class="nc" id="L74">                    JComboBox cb = (JComboBox)e.getSource();</span>
<span class="nc" id="L75">                    String selectedTheme = (String)cb.getSelectedItem();</span>
<span class="nc" id="L76">                    p.setProperty(&quot;theme&quot;, selectedTheme);</span>
<span class="nc" id="L77">                    p.store(writer, null);</span>
<span class="nc" id="L78">                    currentTheme = selectedTheme;</span>
<span class="nc" id="L79">                    applySettings();</span>
<span class="nc" id="L80">                } catch (IOException e1) {</span>
<span class="nc" id="L81">                    e1.printStackTrace();</span>
<span class="nc" id="L82">                }</span>
<span class="nc" id="L83">            }</span>
        });
<span class="nc" id="L85">        ThemeLabel = new JLabel(&quot;Theme: &quot;);</span>

<span class="nc" id="L87">        RestartWarning = new JLabel(&quot;&lt;html&gt;&quot; + &quot;&lt;B&gt;&quot; + &quot;WARNING: Changes below will restart program&quot; + &quot;&lt;/B&gt;&quot; + &quot;&lt;/html&gt;&quot;);</span>

<span class="nc" id="L89">        StyleBox = new JComboBox&lt;&gt;(styleList);</span>
<span class="nc" id="L90">        StyleBox.setSelectedItem(currentStyle);</span>
<span class="nc" id="L91">        StyleBox.addActionListener(new ActionListener() {</span>
            @SuppressWarnings(&quot;rawtypes&quot;)
            @Override
            public void actionPerformed(ActionEvent e) {
<span class="nc" id="L95">                try (FileWriter writer = new FileWriter(SETTINGS_FILE_PATH)) {</span>
<span class="nc" id="L96">                    JComboBox cb = (JComboBox)e.getSource();</span>
<span class="nc" id="L97">                    String selectedStyle = (String)cb.getSelectedItem();</span>
<span class="nc" id="L98">                    p.setProperty(&quot;style&quot;, selectedStyle);</span>
<span class="nc" id="L99">                    p.store(writer, null);</span>
<span class="nc" id="L100">                } catch (IOException e1) {</span>
<span class="nc" id="L101">                    e1.printStackTrace();</span>
<span class="nc" id="L102">                }</span>
<span class="nc" id="L103">            }</span>
        });

<span class="nc" id="L106">        StyleLabel = new JLabel(&quot;Style: &quot;);</span>

<span class="nc" id="L108">        MonoChannelLabel = new JLabel(&quot;MonoChannel Name:&quot;);</span>
<span class="nc" id="L109">        MonoChannelField = new JTextField();</span>
<span class="nc" id="L110">        MonoChannelField.setText(currentMonoChannelName);</span>

<span class="nc" id="L112">        MultiChannel1Label = new JLabel(&quot;MultiChannel 1 Name&quot;);</span>
<span class="nc" id="L113">        MultiChannel1Field = new JTextField();</span>
<span class="nc" id="L114">        MultiChannel1Field.setText(currentMultiChannel1Name);</span>

<span class="nc" id="L116">        MultiChannel2Label = new JLabel(&quot;MultiChannel 2 Name&quot;);</span>
<span class="nc" id="L117">        MultiChannel2Field = new JTextField();</span>
<span class="nc" id="L118">        MultiChannel2Field.setText(currentMultiChannel2Name);</span>

<span class="nc" id="L120">        MultiChannel3Label = new JLabel(&quot;MultiChannel 3 Name&quot;);</span>
<span class="nc" id="L121">        MultiChannel3Field = new JTextField();</span>
<span class="nc" id="L122">        MultiChannel3Field.setText(currentMultiChannel3Name);</span>

<span class="nc" id="L124">        saveButton = new JButton(&quot;Save&quot;); //Only works for Themes</span>
<span class="nc" id="L125">        saveButton.addActionListener(e -&gt; {</span>
<span class="nc" id="L126">            boolean restartNeeded = saveSettings();</span>
<span class="nc" id="L127">            dispose();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            if (restartNeeded) {</span>
<span class="nc" id="L129">                restartApplication();</span>
            }
<span class="nc" id="L131">        });</span>
        
        //Layout

<span class="nc" id="L135">        setLayout(layout);</span>

<span class="nc" id="L137">        gbc.gridheight = 1;</span>
<span class="nc" id="L138">        gbc.gridwidth = 1;</span>
<span class="nc" id="L139">        gbc.weightx = 1.0;</span>
<span class="nc" id="L140">        gbc.weighty = 1.0;</span>
<span class="nc" id="L141">        gbc.fill = GridBagConstraints.NONE;</span>

<span class="nc" id="L143">        Artificer.addObjects(ThemeLabel, this, layout, gbc, 0, 0, 1, 1);</span>
<span class="nc" id="L144">        Artificer.addObjects(ThemeBox, this, layout, gbc, 1, 0, 1, 1);</span>

<span class="nc" id="L146">        gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L147">        Artificer.addObjects(Seperator, this, layout, gbc, 0, 1, 2, 1);</span>
<span class="nc" id="L148">        gbc.fill = GridBagConstraints.NONE;</span>

<span class="nc" id="L150">        Artificer.addObjects(RestartWarning, this, layout, gbc, 0, 2, 2, 1);</span>

<span class="nc" id="L152">        Artificer.addObjects(StyleLabel, this, layout, gbc, 0, 3, 1, 1);</span>
<span class="nc" id="L153">        Artificer.addObjects(StyleBox, this , layout, gbc, 1, 3, 1, 1);</span>

<span class="nc" id="L155">        Artificer.addObjects(MonoChannelLabel, this, layout, gbc, 0, 5, 1, 1);</span>
<span class="nc" id="L156">        Artificer.addObjects(MonoChannelField, this, layout, gbc,1, 5, 1, 1);</span>

<span class="nc" id="L158">        Artificer.addObjects(MultiChannel1Label, this, layout, gbc, 0, 6, 1, 1);</span>
<span class="nc" id="L159">        Artificer.addObjects(MultiChannel1Field, this, layout, gbc, 1, 6, 1, 1);</span>

<span class="nc" id="L161">        Artificer.addObjects(MultiChannel2Label, this, layout, gbc, 0, 7, 1, 1);</span>
<span class="nc" id="L162">        Artificer.addObjects(MultiChannel2Field, this, layout, gbc, 1, 7, 1, 1);</span>

<span class="nc" id="L164">        Artificer.addObjects(MultiChannel3Label, this, layout, gbc, 0, 8, 1, 1);</span>
<span class="nc" id="L165">        Artificer.addObjects(MultiChannel3Field, this, layout, gbc, 1, 8, 1, 1);</span>

<span class="nc" id="L167">        gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L168">        Artificer.addObjects(saveButton, this, layout, gbc, 0, 9, 2, 1);</span>
<span class="nc" id="L169">    }</span>

    private static String initLibraryPath() {
<span class="nc" id="L172">        String cwdLibrary = System.getProperty(&quot;user.dir&quot;) + File.separator + &quot;Library&quot;;</span>
<span class="nc" id="L173">        File cwdDir = new File(cwdLibrary);</span>
<span class="nc bnc" id="L174" title="All 4 branches missed.">        if (cwdDir.exists() &amp;&amp; cwdDir.isDirectory()) {</span>
<span class="nc" id="L175">            return cwdDir.getAbsolutePath();</span>
        }

<span class="nc" id="L178">        String devPath = System.getProperty(&quot;user.dir&quot;) + File.separator + &quot;gooseplayer2&quot; + File.separator + &quot;src&quot; + File.separator + &quot;Library&quot;;</span>
<span class="nc" id="L179">        File devDir = new File(devPath);</span>
<span class="nc bnc" id="L180" title="All 4 branches missed.">        if (devDir.exists() &amp;&amp; devDir.isDirectory()) {</span>
<span class="nc" id="L181">            return devDir.getAbsolutePath();</span>
        }

        try {
<span class="nc" id="L185">            File codeSource = new File(Config.class.getProtectionDomain().getCodeSource().getLocation().toURI());</span>
<span class="nc" id="L186">            File jarDir = codeSource.getParentFile();</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (jarDir != null) {</span>
<span class="nc" id="L188">                File libDir = new File(jarDir, &quot;Library&quot;);</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">                if (libDir.exists() &amp;&amp; libDir.isDirectory()) {</span>
<span class="nc" id="L190">                    return libDir.getAbsolutePath();</span>
                }
            }
<span class="nc" id="L193">        } catch (Exception ignored) {}</span>

<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (!cwdDir.exists()) {</span>
<span class="nc" id="L196">            cwdDir.mkdirs();</span>
        }
<span class="nc" id="L198">        return cwdDir.getAbsolutePath();</span>
    }

    private boolean saveSettings() {
<span class="nc" id="L202">        boolean restartRequired = false;</span>
<span class="nc" id="L203">        try (FileWriter writer = new FileWriter(SETTINGS_FILE_PATH)) {</span>

            // Detect changes that require restart (non-theme settings)
<span class="nc bnc" id="L206" title="All 2 branches missed.">            boolean styleChanged = !Objects.equals(currentStyle, p.getProperty(&quot;style&quot;));</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            boolean monoChanged = !Objects.equals(currentMonoChannelName, MonoChannelField.getText());</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            boolean multi1Changed = !Objects.equals(currentMultiChannel1Name, MultiChannel1Field.getText());</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">            boolean multi2Changed = !Objects.equals(currentMultiChannel2Name, MultiChannel2Field.getText());</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            boolean multi3Changed = !Objects.equals(currentMultiChannel3Name, MultiChannel3Field.getText());</span>

            // Persist updates
<span class="nc" id="L213">            p.setProperty(&quot;monochannelname&quot;, MonoChannelField.getText());</span>
<span class="nc" id="L214">            p.setProperty(&quot;multichannel1name&quot;, MultiChannel1Field.getText());</span>
<span class="nc" id="L215">            p.setProperty(&quot;multichannel2name&quot;, MultiChannel2Field.getText());</span>
<span class="nc" id="L216">            p.setProperty(&quot;multichannel3name&quot;, MultiChannel3Field.getText());</span>

<span class="nc" id="L218">            p.store(writer, null);</span>

            // Apply theme immediately; other changes may need restart
<span class="nc" id="L221">            applySettings();</span>

<span class="nc bnc" id="L223" title="All 10 branches missed.">            restartRequired = styleChanged || monoChanged || multi1Changed || multi2Changed || multi3Changed;</span>
<span class="nc" id="L224">        } catch (IOException e) {</span>
<span class="nc" id="L225">            e.printStackTrace();</span>
<span class="nc" id="L226">        }</span>
<span class="nc" id="L227">        return restartRequired;</span>
    }

    public static void applySettings() {
<span class="nc" id="L231">        SwingUtilities.invokeLater(() -&gt; {</span>
            try {
<span class="nc" id="L233">                UIManager.setLookAndFeel(UIManager.getCrossPlatformLookAndFeelClassName());</span>
<span class="nc" id="L234">                Properties p = new Properties();</span>
<span class="nc" id="L235">                p.load(new FileReader(SETTINGS_FILE_PATH));</span>

<span class="nc" id="L237">                applyTheme(p.getProperty(&quot;theme&quot;, &quot;&quot;));</span>

<span class="nc" id="L239">            } catch (Exception e) {</span>
<span class="nc" id="L240">                e.printStackTrace();</span>
<span class="nc" id="L241">            }</span>
<span class="nc" id="L242">            SwingUtilities.updateComponentTreeUI(JFrame.getFrames()[0]);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">            for (Window window : Window.getWindows()) {</span>
<span class="nc" id="L244">                SwingUtilities.updateComponentTreeUI(window);</span>
            }
<span class="nc" id="L246">        });</span>
<span class="nc" id="L247">    }</span>

    public static void applyTheme(String theme) {
<span class="nc bnc" id="L250" title="All 10 branches missed.">        switch (theme) {</span>
            case &quot;Light Flat&quot;:
<span class="nc" id="L252">                FlatLightFlatIJTheme.setup();</span>
<span class="nc" id="L253">                break;</span>
            case &quot;Solarized Light&quot;:
<span class="nc" id="L255">                FlatSolarizedLightIJTheme.setup();</span>
<span class="nc" id="L256">                break;</span>
            case &quot;Arc&quot; :
<span class="nc" id="L258">                FlatArcIJTheme.setup();</span>
<span class="nc" id="L259">                break;</span>
            case &quot;Dark Flat&quot;:
<span class="nc" id="L261">                FlatDarkFlatIJTheme.setup();</span>
<span class="nc" id="L262">                break;</span>
            case &quot;Arc Dark&quot;: 
<span class="nc" id="L264">                FlatArcDarkIJTheme.setup();</span>
<span class="nc" id="L265">                break;</span>
            case &quot;Arc Dark Orange&quot;:
<span class="nc" id="L267">                FlatArcDarkOrangeIJTheme.setup();</span>
<span class="nc" id="L268">                break;</span>
            case &quot;Hiberbee Dark&quot;:
<span class="nc" id="L270">                FlatHiberbeeDarkIJTheme.setup();</span>
<span class="nc" id="L271">                break;</span>
            case &quot;Dark Purple&quot;:
<span class="nc" id="L273">                FlatDarkPurpleIJTheme.setup();</span>
<span class="nc" id="L274">                break;</span>
            case &quot;Nord&quot;:
<span class="nc" id="L276">                FlatNordIJTheme.setup();</span>
<span class="nc" id="L277">                break;</span>
            default:
<span class="nc" id="L279">                FlatLightFlatIJTheme.setup();</span>
                break;
        }
<span class="nc" id="L282">    }</span>

    private static String initSettingsPath() {
<span class="nc" id="L285">        String appData = System.getenv(&quot;APPDATA&quot;);</span>
        String targetPath;
<span class="nc bnc" id="L287" title="All 4 branches missed.">        if (appData != null &amp;&amp; !appData.isEmpty()) {</span>
<span class="nc" id="L288">            targetPath = appData + File.separator + &quot;GoosePlayer2&quot; + File.separator + &quot;settings.txt&quot;;</span>
        } else {
<span class="nc" id="L290">            targetPath = System.getProperty(&quot;user.dir&quot;) + File.separator + &quot;settings.txt&quot;;</span>
        }

<span class="nc" id="L293">        File settingsFile = new File(targetPath);</span>
<span class="nc" id="L294">        File parentDir = settingsFile.getParentFile();</span>
<span class="nc bnc" id="L295" title="All 4 branches missed.">        if (parentDir != null &amp;&amp; !parentDir.exists()) {</span>
<span class="nc" id="L296">            parentDir.mkdirs();</span>
        }

<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (!settingsFile.exists()) {</span>
<span class="nc" id="L300">            try (InputStream in = Config.class.getResourceAsStream(&quot;/settings.txt&quot;)) {</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">                if (in != null) {</span>
<span class="nc" id="L302">                    try (FileOutputStream out = new FileOutputStream(settingsFile)) {</span>
<span class="nc" id="L303">                        byte[] buffer = new byte[8192];</span>
                        int read;
<span class="nc bnc" id="L305" title="All 2 branches missed.">                        while ((read = in.read(buffer)) != -1) {</span>
<span class="nc" id="L306">                            out.write(buffer, 0, read);</span>
                        }
                    }
                } else {
<span class="nc" id="L310">                    settingsFile.createNewFile();</span>
                }
<span class="nc" id="L312">            } catch (IOException e) {</span>
<span class="nc" id="L313">                e.printStackTrace();</span>
<span class="nc" id="L314">            }</span>
        }

<span class="nc" id="L317">        return settingsFile.getAbsolutePath();</span>
    }

    private static void restartApplication() {
        try {
<span class="nc" id="L322">            String javaBinBase = System.getProperty(&quot;java.home&quot;) + File.separator + &quot;bin&quot; + File.separator + &quot;java&quot;;</span>
<span class="nc" id="L323">            String javaBin = javaBinBase;</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            if (System.getProperty(&quot;os.name&quot;).toLowerCase().contains(&quot;win&quot;)) {</span>
<span class="nc" id="L325">                File javaExe = new File(javaBinBase + &quot;.exe&quot;);</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">                if (javaExe.exists()) {</span>
<span class="nc" id="L327">                    javaBin = javaExe.getAbsolutePath();</span>
                }
            }

<span class="nc" id="L331">            String classPath = System.getProperty(&quot;java.class.path&quot;);</span>
<span class="nc" id="L332">            String mainClass = &quot;com.gooseplayer2.Main&quot;;</span>

<span class="nc" id="L334">            ProcessBuilder builder = new ProcessBuilder(javaBin, &quot;-cp&quot;, classPath, mainClass);</span>
<span class="nc" id="L335">            builder.directory(new File(System.getProperty(&quot;user.dir&quot;)));</span>
<span class="nc" id="L336">            builder.start();</span>
<span class="nc" id="L337">        } catch (IOException ex) {</span>
<span class="nc" id="L338">            ex.printStackTrace();</span>
<span class="nc" id="L339">            return;</span>
<span class="nc" id="L340">        }</span>
<span class="nc" id="L341">        System.exit(0);</span>
<span class="nc" id="L342">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>